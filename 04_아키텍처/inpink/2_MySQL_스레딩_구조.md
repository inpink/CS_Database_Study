# MySQL 스레딩 구조

MySQL 서버는 프로세스 기반이 아닌, **스레드 기반**으로 작동한다.　   
크게 ⓐ Foreground thread,  ⓑ Background thread 2가지로 구분할 수 있다.　   
　   
ⓐ Foreground thread(=사용자 스레드)　   
  - DBMS의 앞단에서 사용자(클라이언트)가 요청한 작업을 처리하기에, 포그라운드라고 부른다.　   
  - 주로 각 클라이언트의 사용자가 요청한 쿼리를 처리하는 역할을 한다.　   
  - 최소한 MySQL 서버에 접속한 클라이언트의 수만큼 존재한다.　   
  - 쿼리를 처리할 때, 필요한 데이터를 **MySQL의 버퍼, 캐시**에서 직접 가져온다. 이 곳에 없는 경우, 직접 **디스크**에 접근하여 **데이터 파일, 인덱스 파일**로부터 읽어온다. 　   
  - InnoDB storage engine : 디스크에 데이터를 쓰는 작업은 Background thread가 함　   
  - MyISAM storage engine : 디스크에 데이터를 쓰는 작업까지 Foreground thread가 함　   
　   


ⓑ Background thread　   
  - MyISAM에는 거의 해당되는 부분이 없지만, InnoDB는 아래와 같은 작업을 Background thread을 이용하여 처리한다.
      
  - Insert Buffer 병합　   
    : 여러 개의 INSERT 연산이 동일한 데이터 페이지의 작업을 수행하는 경우, Insert Buffer는 이러한 작업들을 병합하여 데이터 페이지에 대한 I/O 작업을 최소화함
       
  - **로그를 디스크로 기록(Log thread)**　   
    : 변경 작업을 일시적으로 로그 버퍼에 저장하고, 이후 로그 파일에 쓰기 작업을 수행한다.　   
    : 이를 통해 데이터 변경 로그 작업을 최적화하고 I/O 작업을 줄일 수 있다.
    
  - **InnoDB 버퍼 풀의 데이터를 디스크에 기록(Write thread)**　   
    : 데이터를 읽는 작업은 보통 Foreground thread를 이용하지만, 쓰기는 Background thread를 많이 이용한다.　   
    : 시스템 변수 innodb_write_io_threads를 통해 설정해줄 수 있다.　   
    : 내장 디스크를 사용할 때는 2~4개의 스레드 개수가 적당하고, DAS나 SAN같은 스토리지를 이용할 때는 가능한 만큼 충분히 설정할 수 있다.　   
    
  - 이외로도 "데이터를 버퍼로 읽어오기, 잠금 모니터링, 데드락 모니터링" 등의 작업을 수행한다. 　   

　   
　   
💙 **버퍼링(Buffering)**　   
**데이터를 일시적으로 저장하거나 메모리에 임시로 보관한다.**　   
Java에서도 데이터를 입출력할 때 BufferedReader와 BuffredWriter를 써서, 데이터를 어느 정도 모아서 입출력했다. 　   
MySQL도 마찬가지이다. 데이터의 입출력의 성능 향상을 위해 버퍼링을 사용한다.　   
데이터 처리 속도 차이나 데이터 흐름의 조절을 위해 사용되며, 자주 액세스되는 데이터를 메모리에 보관하여 디스크 또는 네트워크 액세스를 피하고 성능을 향상시킬 수도 있다.　   
　   
InnoDB는 쓰기 버퍼링을 적극 사용하여, INSERT/UPDATE/DELETE 쿼리로 데이터가 변경되는 경우, **데이터가 디스크의 데이터 파일로 즉시 저장되지 않을 수 있다.**　   
따라서, 데이터가 다 저장될때까지 기다리지 않아도 된다. 잠시 버퍼나 로그에 담아두고 다른 작업을 하면 된다.　   
　   
하지만, MyISAM은 일반적으로 쓰기 버퍼링을 사용하지 않는다. 모든 데이터가 다 저장된 다음에야, 다음 작업을 할 수 있다.　   
사용자들이 하나의 테이블에 대해 여러 작업을 하기에 대기 시간이 걸릴 수 있다는 것이다.　   
　   
**데이터의 쓰기 작업은 지연(버퍼링) 될 수 있다. 하지만, 읽기 작업은 절대! 지연될 수 없다.**　   
사용자가 SELECT 쿼리를 입력했는데, 검색 결과를 **나중에** 보여주면 안되기 때문이다. 　   
　   
　   
> 실행중인 스레드의 목록 확인하기

MySQL 서버에서 실행중인 스레드의 목록은 아래 명령어를 통해 확인할 수 있다.　   
performance_schema 데이터베이스의 threads 테이블을 참고하자.　   
~~~
SELECT * FROM performance_schema.threads ORDER BY type, thread_id;
~~~
![image](https://github.com/inpink/CS_Database_Study/assets/108166692/d34fcd34-cc7e-406f-8c97-6bb589837118)　   
=> 전체 40개의 스레드가 실행중이다. 그 중 4개만 포그라운드 스레드인 것을 확인할 수 있다.　   
=> "thread/innodb/io_read_thread"처럼 같은 이름의 스레드가 여러 개 보이기도 하는데,　   
이 것은 **여러 개의 스레드가 같은 작업을 병렬로 처리**하기 때문이다.　   
병렬 처리 옵션은 MySQL 서버의 설정에서 변경할 수 있다.　   
　   
　   
　   
> 메모리 할당 및 사용 구조

도서 84p의 그림 4.3을 참고하자.　   
　   
MySQL의 메모리 공간은 크게 ⓐ 글로벌 메모리 영역, ⓑ 로컬(세션, 클라이언트) 메모리 영역 2가지로 나누어진다.　   
　   
ⓐ 글로벌 메모리 영역　   
  - 모든 스레드에 의해 공유되는 메모리 영역이다.　   
  - **InnoDB 버퍼 풀, MyISAM 키 캐시, 바이너리 로그 버퍼, 리두 로그 버퍼, 테이블 캐시** 등이 포함된다.　   

　   
ⓑ 로컬(세션, 클라이언트) 메모리 영역　   
  - 각 클라이언트 스레드가 로컬 메모리 영역의 일부를 할당받아 각각 사용한다.　   
  - 절대 공유되어 사용되지 않는다.　   
  - **조인 버퍼, 정렬(sort) 버퍼, 네트워크 버퍼, 리드 버퍼, 바이너리 로그 캐시** 등이 포함된다.　   
